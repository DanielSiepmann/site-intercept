{% extends 'base.html.twig' %}
{% block title %}Documentation deployments{% endblock %}
{% block headline %}Deployed documentation{% endblock %}
{% block body %}

    <div class="content-section">
        <div class="container">

            <h2>
                {{ include('partials/bambooStatus.html.twig') }}
            </h2>

            <h2>
                Deployed documentation projects
            </h2>
            <div class="card">
                <div class="datatable">
                    <table class="datatable-table">
                        <thead>
                            <tr>
                                <th scope="col" data-type="uid">Id</th>
                                <th scope="col" colspan="2">Package</th>
                                <th scope="col">Type</th>
                                <th scope="col">Branch</th>
                                <th scope="col">Target</th>
                                <th scope="col">Created</th>
                                <th scope="col">Last rendered</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for deployment in deployments %}
                            <tr>
                                <th scope="row" data-type="uid">{{ deployment.id }}</th>
                                <th data-type="icon">
                                    <a href="{{ deployment.repositoryUrl }}" title="{{ deployment.repositoryUrl }}" class="datatable-link-highlight" rel="noopener" target="_blank">
                                        <i class="fab fa-fw fa-git-alt"></i>
                                    </a>
                                </th>
                                <th data-type="title">
                                    <strong>{{ deployment.packageName }}</strong><br>
                                </th>
                                <td>{{ deployment.typeLong }}</td>
                                <td>{{ deployment.branch }}</td>
                                <td>
                                    <a href="{{ docsLiveServer }}/{{ deployment.typeShort }}/{{ deployment.packageName }}/{{ deployment.targetBranchDirectory }}" rel="noopener" target="_blank">
                                        {{ deployment.targetBranchDirectory }}
                                    </a>
                                </td>
                                <td data-type="localdate">
                                    <span data-processor="localdate" data-value="{{ deployment.createdAt|date('Y-m-d\\TH:i:sP', "UTC") }}">
                                        {{ deployment.createdAt|date('n/d/Y, g:i A', "UTC") }}
                                    </span>
                                </td>
                                <td data-type="localdate">
                                    <span data-processor="localdate" data-value="{{ deployment.lastRenderedAt|date('Y-m-d\\TH:i:sP', "UTC") }}">
                                        {{ deployment.lastRenderedAt|date('n/d/Y, g:i A', "UTC") }}
                                    </span>
                                </td>
                                <td data-type="actions" data-label="Actions">
                                    {% if deployment.isActionable() %}
                                        <a class="datatable-action" href="{{ path('admin_docs_deployments_delete_view', {'documentationJarId': deployment.getId()}) }}">
                                            <span class="datatable-action-icon"><i class="fa fa-trash"></i></span>
                                            <span class="datatable-action-label datatable-visually-hidden">Delete</span>
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="9">no records found</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <h2>
                Recent actions
            </h2>
            {% for log in logMessages %}
                <div class="alert graylog-log
                        alert-success
                        {% if log.level == '6' %}
                            alert-success
                        {% else %}
                            alert-warning
                        {% endif %}
                    "
                >
                    <span>{{ log.time|date("d.m.Y H:i:s") }} UTC - </span>
                    <span>
                        {% if log.status == 'triggered' %}
                            <a href="https://bamboo.typo3.com/browse/{{ log.bambooKey }}">{{ log.message }}</a>
                        {% else %}
                            {{ log.message }}
                        {% endif %}
                    </span>

                    {% if log.bambooKey %}
                        | <span>Bamboo key: {{ log.bambooKey }}</span>
                    {% endif %}
                    {% if log.package %}
                        | <span>Package: {{ log.package }}</span>
                    {% endif %}
                    {% if log.sourceBranch %}
                        | <span>Branch: {{ log.sourceBranch }}</span>
                    {% endif %}
                    {% if log.targetBranch %}
                        | <span>Target directory: {{ log.targetBranch }}</span>
                    {% endif %}
                    {% if log.repository %}
                        | <span>Repository: {{ log.repository }}</span>
                    {% endif %}
                    {% if log.composerFile %}
                        | <span>Composer file: {{ log.composerFile }}</span>
                    {% endif %}
                    {% if log.exceptionCode %}
                        | <span>Exception Code: {{ log.exceptionCode }}</span>
                    {% endif %}
                    {% if log.triggeredBy == 'api' %}
                        | <span>Trigger: API</span>
                    {% elseif log.triggeredBy == 'interface' %}
                        | <span>Trigger: Web</span>
                    {% endif %}
                    {% if log.userDisplayName %}
                        | <span>User: {{ log.userDisplayName }}</span>
                    {% endif %}
                </div>
            {% endfor %}

        </div>
    </div>

{% endblock %}
